<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
  <script type="module">
    import Module from '/build/imageconverter.js';
    Module().then(Module => {
      let origWidth = 0, origHeight = 0;
      const fileInput = document.getElementById('fileInput');
      const widthInput = document.getElementById('width');
      const heightInput = document.getElementById('height');
      const convertBtn = document.getElementById('convertBtn');
      const outputImg = document.getElementById('output');
      const qualityInput = document.getElementById('quality');
      const qualityValue = document.getElementById('qualityValue');
      qualityInput.addEventListener('input', () => {
               qualityValue.textContent = qualityInput.value;
          });

      // auto-detect image dimensions on file selection
      fileInput.addEventListener('change', () => {
        if (!fileInput.files.length) return;
        const file = fileInput.files[0];
        const imgTmp = new Image();
        imgTmp.onload = () => {
          origWidth = imgTmp.naturalWidth;
          origHeight = imgTmp.naturalHeight;
          widthInput.value = imgTmp.naturalWidth;
          heightInput.value = imgTmp.naturalHeight;
          URL.revokeObjectURL(imgTmp.src);
        };
        imgTmp.src = URL.createObjectURL(file);
       
      });

      const resizeModeInput = document.getElementById('resizeMode');
      resizeModeInput.addEventListener('change', () => {
        document.getElementById('fixedResizeInputs').style.display = resizeModeInput.value === 'fixed' ? '' : 'none';
        document.getElementById('percentResizeInputs').style.display = resizeModeInput.value === 'percent' ? '' : 'none';
      });
      const keepAspectCheckbox = document.getElementById('keepAspect');
      widthInput.addEventListener('input', () => {
        if (resizeModeInput.value === 'fixed' && keepAspectCheckbox.checked && origWidth && origHeight) {
          heightInput.value = Math.round(widthInput.value * origHeight / origWidth);
        }
      });
      heightInput.addEventListener('input', () => {
        if (resizeModeInput.value === 'fixed' && keepAspectCheckbox.checked && origWidth && origHeight) {
          widthInput.value = Math.round(heightInput.value * origWidth / origHeight);
        }
      });

      convertBtn.addEventListener('click', async () => {
        if (!fileInput.files.length) {
          alert('Please select an image file.');
          return;
        }
        const file = fileInput.files[0];
        // Compute resize dimensions
        let width, height;
        const mode = document.getElementById('resizeMode').value;
        if (mode === 'percent') {
          const percent = parseInt(document.getElementById('percentValue').value, 10);
          width = Math.round(origWidth * percent / 100);
          height = Math.round(origHeight * percent / 100);
        } else {
          width = parseInt(widthInput.value, 10);
          height = parseInt(heightInput.value, 10);
          if (document.getElementById('keepAspect').checked) {
            height = Math.round(width * origHeight / origWidth);
          }
        }
        const buffer = await file.arrayBuffer();
        const uint8 = new Uint8Array(buffer);
        const config = new Module.EncodeConfig();
        config.codecChoice = Module.CodecChoice.AOM;
        // set chroma subsampling based on user selection
        const pf = document.getElementById('pixelFormat').value;
        config.pixelFormat = Module.AvifPixelFormat[pf];
        config.quality = parseInt(qualityInput.value); 
        config.speed = parseInt(document.getElementById('speed').value);
        config.tune = parseInt(document.getElementById('tune').value);
        config.sharpness = parseInt(document.getElementById('sharpness').value);
        config.tileRowsLog2=parseInt(document.getElementById('tileRows').value);
        config.tileColsLog2=parseInt(document.getElementById('tileCols').value);
        try {
          const result = Module.convertImage(uint8, width, height, config);
          const view = result.getData();
          const copy = new Uint8Array(view); // Correct copy
           result.delete(); // Now safe to free WASM memory

          console.log('From JS AVIF data size:', copy.byteLength);
            // Use the copied data to create the Blob
           const blob = new Blob([copy], { type: 'image/avif' });
          // Update size stats
          const originalSize = file.size;
          const newSize = copy.byteLength;
          const compression = ((originalSize - newSize) / originalSize * 100).toFixed(2);
          document.getElementById('originalSize').textContent = `${(originalSize/1024).toFixed(2)} KB`;
          document.getElementById('newSize').textContent = `${(newSize/1024).toFixed(2)} KB`;
          document.getElementById('compressionPercent').textContent = `${compression}%`;
          const url = URL.createObjectURL(blob);
          console.log(url);
          outputImg.src = url;
          const downloadLink = document.getElementById('downloadLink');
          downloadLink.href = url;
          downloadLink.download = 'converted.avif';
          downloadLink.style.display = 'block';
          downloadLink.textContent = '⬇️ Download AVIF';
        } catch (e) {
          console.error('Conversion error:', e);
          alert('Conversion failed: ' + (e.message || e));
        }
      });
    });
  </script>
  <title>ConvAvif - AVIF Image Converter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 640px;
      margin: 40px auto;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    .project-header h1 {
      margin: 0;
      font-size: 2em;
      text-align: center;
    }
    .project-header p {
      text-align: center;
      margin: 0 0 20px;
      color: #666;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }
    .controls input[type="file"] {
      flex: 1 1 auto;
    }
    .controls input[type="number"] {
      width: 80px;
      padding: 5px;
    }
    .controls button {
      padding: 8px 16px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .controls button:hover {
      background: #0055aa;
    }
    img#output {
      display: block;
      margin-top: 20px;
      max-width: 100%;
      border: 1px solid #ddd;
    }
    a#downloadLink {
      display: inline-block;
      margin-top: 10px;
      color: #0066cc;
      text-decoration: none;
    }
    a#downloadLink:hover {
      text-decoration: underline;
    }
    .advanced-settings {
  margin: 15px 0;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 4px;
}

.advanced-settings summary {
  cursor: pointer;
  font-weight: bold;
}

.advanced-controls {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 10px;
}

.advanced-controls label {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.advanced-controls input[type="number"] {
  width: 80px;
  padding: 5px;
}
.stats {
  display: flex;
  gap: 20px;
  margin-bottom: 10px;
}
.stats span {
  flex: 1;
  text-align: center;
}
  </style>
</head>
<body>
  <div class="project-header">
    <h1>ConvAvif</h1>
    <p>AVIF Image Converter</p>
  </div>
  <div class="controls">
    <input type="file" id="fileInput" accept="image/*" required />
    <label for="resizeMode">Resize Mode:</label>
    <select id="resizeMode">
      <option value="fixed" selected>Fixed</option>
      <option value="percent">Percentage</option>
    </select>
    <div id="fixedResizeInputs">
      <label for="width">Width:</label>
      <input type="number" id="width" value="800" placeholder="px" required />
      <label for="height">Height:</label>
      <input type="number" id="height" value="600" placeholder="px" required />
      <label><input type="checkbox" id="keepAspect" checked> Keep aspect ratio</label>
    </div>
    <div id="percentResizeInputs" style="display:none;">
      <label for="percentValue">Percent (%):</label>
      <input type="number" id="percentValue" min="1" max="100" value="100">
    </div>
    <label for="quality">Quality:</label>
    <input type="range" id="quality" min="0" max="99" value="30">
    <span id="qualityValue">30</span>
    <button id="convertBtn">Convert to AVIF</button>
  </div>
<details class="advanced-settings">
  <summary>Advanced Settings</summary>
  <div class="advanced-controls">
    <label for="speed">Speed (0-10):</label>
    <input type="number" id="speed" min="0" max="10" value="6">
    
    <label for="tune">Tune:</label>
    <select id="tune">
      <option value="0">Default</option>
      <option value="1">PSNR</option>
      <option value="2">SSIM</option>
    </select>

    <label for="sharpness">Sharpness (0-7):</label>
    <input type="number" id="sharpness" min="0" max="7" value="0">
    
    <label for="pixelFormat">Chroma Subsampling:</label>
    <select id="pixelFormat">
      <option value="YUV400">4:0:0</option>
      <option value="YUV420" selected>4:2:0</option>
      <option value="YUV422">4:2:2</option>
      <option value="YUV444">4:4:4</option>
    </select>
    
    <label for="tileRows">Tile Rows Log2:</label>
    <input type="number" id="tileRows" min="0" max="6" value="0">
    
    <label for="tileCols">Tile Columns Log2:</label>
    <input type="number" id="tileCols" min="0" max="6" value="0">
  </div>
</details>
  <div class="stats">
    <span>Original size: <span id="originalSize">-</span></span>
    <span>New size: <span id="newSize">-</span></span>
    <span>Compression: <span id="compressionPercent">-</span></span>
  </div>
  <img id="output" src="/asset/placeholder.svg" alt="Converted AVIF will appear here" />
  <a id="downloadLink" style="display:none;"></a>
</body>
</html>
